<div class="container">
  <div class="header">
    <h1>Gestion des Commandes</h1>
    <button class="btn-primary" (click)="showForm.set(!showForm())">
      {{ showForm() ? 'Annuler' : '+ Nouvelle Commande' }}
    </button>
  </div>

  @if (showForm()) {
  <div class="order-form-card">
    <h3>D√©tails de la commande</h3>
    <form (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label>ID Client</label>
        <input type="number" [(ngModel)]="newOrder.userId" name="userId" required>
      </div>

      <div class="payment-methods-grid">
        <div class="form-group">
          <label>Mode de Paiement</label>
          <select [(ngModel)]="newOrder.paymentMethod" name="paymentMethod" class="form-control">
            <option value="CASH">CASH (Esp√®ces)</option>
            <option value="CREDIT">CR√âDIT (Dette)</option>
            <option value="3ARBON">3ARBON (Avance)</option>
          </select>
        </div>

        @if (newOrder.paymentMethod === '3ARBON') {
        <div class="form-group">
          <label>Montant de l'avance (3arbon)</label>
          <input type="number" [(ngModel)]="newOrder.downPayment" name="downPayment" placeholder="0.00 ‚Ç¨" required>
        </div>
        }
      </div>

      <div class="items-section">
        <h4>Articles</h4>
        @for (item of newOrder.items; track $index) {
        <div class="item-row">
          <select [(ngModel)]="item.productId" name="prod-{{$index}}" class="form-control"
            (change)="onProductChange(item)" required>
            <option [ngValue]="null" disabled selected>Choisir un produit</option>
            @for (product of allProducts(); track product.id) {
            <option [value]="product.id">{{ product.name }}</option>
            }
          </select>

          <input type="number" placeholder="Quantit√©" [(ngModel)]="item.quantity" name="qty-{{$index}}" required>
          <input type="number" placeholder="Prix Unitaire" [(ngModel)]="item.price" name="price-{{$index}}" required>

          <button type="button" class="btn-remove" (click)="removeItem($index)">√ó</button>
        </div>
        }
        <button type="button" class="btn-add-item" (click)="addItem()">+ Ajouter un article</button>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-save">Enregistrer la commande</button>
      </div>
    </form>
  </div>
  }
</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Date</th>
        <th>Client</th>
        <th>Total</th>
        <th>Paiement</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      @for (order of orders(); track order.id) {
      <tr>
        <td>#{{ order.id }}</td>
        <td>{{ order.orderDate | date:'dd/MM HH:mm' }}</td>
        <td>{{ order.user.username || 'Client Inconnu' }}</td>
        <td class="amount">{{ order.totalAmount | number:'1.2-2' }} ‚Ç¨</td>

        <td>
          @if (order.paymentMethod) {
          <span [class]="'badge-payment badge-' + order.paymentMethod.toLowerCase()">
            {{ order.paymentMethod }}
            @if (order.paymentMethod === '3ARBON' && order.downPayment) {
            <small class="down-payment-text">({{ order.downPayment }} ‚Ç¨)</small>
            }
          </span>
          } @else {
          <span class="text-muted">Non d√©fini</span>
          }
        </td>

        <td>
          <select [class]="'status-select ' + getStatusClass(order.status)"
            (change)="changeStatus(order.id, $any($event.target).value)">
            <option value="PENDING" [selected]="order.status === 'PENDING'">EN ATTENTE</option>
            <option value="SHIPPED" [selected]="order.status === 'SHIPPED'">EXP√âDI√â</option>
            <option value="DELIVERED" [selected]="order.status === 'DELIVERED'">LIVR√â</option>
            <option value="CANCELLED" [selected]="order.status === 'CANCELLED'">ANNUL√â</option>
          </select>
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn-view" (click)="onViewInvoice(order.id)" title="Voir la facture">üëÅÔ∏è</button>
            <button class="btn-delete" (click)="onDelete(order.id)" title="Supprimer">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
      }
    </tbody>
  </table>

  <div class="pagination-container">
    <div class="pagination-info">
      Page {{ currentPage() + 1 }} sur {{ totalPages() }}
    </div>
    <div class="pagination-buttons">
      <button class="btn-pagination" [disabled]="currentPage() === 0" (click)="changePage(-1)">
        &laquo; Pr√©c√©dent
      </button>
      <button class="btn-pagination" [disabled]="currentPage() >= totalPages() - 1" (click)="changePage(1)">
        Suivant &raquo;
      </button>
    </div>
  </div>
</div>
